<!-- Intelligent Chat Widget -->
<div id="chat-widget">
    <!-- Chat Button -->
    <button id="chat-button" class="chat-button" aria-label="Open chat">
        <svg class="chat-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <svg class="close-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        <span class="chat-badge">1</span>
    </button>

    <!-- Chat Window -->
    <div id="chat-window" class="chat-window">
        <div class="chat-header">
            <div class="chat-header-info">
                <img src="logo.png" alt="X-Tech" class="chat-logo">
                <div>
                    <h3>X-Tech Assistant</h3>
                    <p class="chat-status"><span class="status-dot"></span> Online</p>
                </div>
            </div>
            <button id="minimize-chat" class="minimize-button" aria-label="Minimize chat">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
        </div>

        <div class="chat-body">
            <div class="chat-messages" id="chat-messages">
                <!-- Messages will be added here dynamically -->
            </div>

            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typing-indicator" style="display: none;">
                <span></span>
                <span></span>
                <span></span>
            </div>

            <!-- Quick Action Buttons -->
            <div class="quick-actions" id="quick-actions">
                <button class="quick-action-btn" data-action="contact">üìû Contact Info</button>
                <button class="quick-action-btn" data-action="services">üíº Our Services</button>
                <button class="quick-action-btn" data-action="hours">üïê Business Hours</button>
                <button class="quick-action-btn" data-action="human">üë§ Talk to Human</button>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-container" id="chat-input-container">
                <textarea id="chat-input" placeholder="Ask me anything..." rows="1"></textarea>
                <button type="button" id="send-button" class="chat-send-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>

            <!-- Contact Form (Hidden Initially) -->
            <div class="contact-form-container" id="contact-form-container" style="display: none;">
                <form id="contact-form">
                    <input type="text" id="contact-name" placeholder="Your name *" required>
                    <input type="email" id="contact-email" placeholder="Your email *" required>
                    <input type="tel" id="contact-phone" placeholder="Your phone (optional)">
                    <textarea id="contact-message" placeholder="Your message *" rows="3" required></textarea>
                    <button type="submit" class="submit-btn">Send Message</button>
                    <button type="button" class="cancel-btn" id="cancel-form">Back to Chat</button>
                </form>
            </div>
        </div>

        <div class="chat-footer">
            <p>Powered by X-Tech AI Assistant</p>
        </div>
    </div>
</div>

<script>
// ============================================
// CONFIGURATION - Update this with your Google Apps Script URL
// ============================================
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxVyIEVATSSRSf3R5Y283F8DRgBX9X6zPIQtr7HD0-zH__se72ToVsfwKCH1DRaTc5fsA/exec';

// ============================================
// Intelligent Chatbot System
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    const chatButton = document.getElementById('chat-button');
    const chatWindow = document.getElementById('chat-window');
    const minimizeChat = document.getElementById('minimize-chat');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const chatBadge = document.querySelector('.chat-badge');
    const typingIndicator = document.getElementById('typing-indicator');
    const quickActions = document.getElementById('quick-actions');
    const chatInputContainer = document.getElementById('chat-input-container');
    const contactFormContainer = document.getElementById('contact-form-container');
    const contactForm = document.getElementById('contact-form');
    const cancelFormBtn = document.getElementById('cancel-form');

    let chatOpen = false;
    let conversationHistory = [];

    // ============================================
    // Knowledge Base - Add/Edit Q&A Here
    // ============================================
    const knowledgeBase = {
        contact: {
            keywords: ['contact', 'phone', 'email', 'call', 'reach', 'address', 'location', 'where'],
            response: `üìû <strong>Contact Information:</strong><br><br>
                <strong>Phone:</strong> (405) 247-0083<br>
                <strong>Email:</strong> sales@x-tech.tv<br>
                <strong>Location:</strong> Oklahoma City, Oklahoma<br><br>
                You can also <a href="https://calendar.google.com/calendar/appointments/schedules/AcZssZ2uSOKodtmVHB_wPc6rUDklUM8oSZb-pTpbh-B0quILGAjkbSwmtRCR88ARiRgIMSwZ7ERBwBRG?gv=true" target="_blank">schedule a call</a> with us!`
        },
        hours: {
            keywords: ['hours', 'open', 'closed', 'available', 'time', 'when', 'schedule'],
            response: `üïê <strong>Business Hours:</strong><br><br>
                We're available Monday through Friday, 8:00 AM - 6:00 PM Central Time.<br><br>
                For urgent matters outside business hours, please email us at sales@x-tech.tv and we'll respond as soon as possible.`
        },
        services: {
            keywords: ['service', 'offer', 'do', 'help', 'provide', 'consulting', 'transformation', 'what'],
            response: `üíº <strong>Our Services:</strong><br><br>
                <strong>1. SMB Support:</strong> Digital transformation, legacy modernization, change management, and Google Workspace management<br><br>
                <strong>2. Consultant Consultation:</strong> Methodology development, sales support, proposal expertise, and AI strategy<br><br>
                <strong>3. Product Services:</strong> Implementation for Google Workspace, Laserfiche, OneSpan Sign, Grooper, and more<br><br>
                Visit our <a href="services.html">Services page</a> for details!`
        },
        pricing: {
            keywords: ['price', 'cost', 'fee', 'rate', 'charge', 'expensive', 'budget', 'quote'],
            response: `üí∞ <strong>Pricing:</strong><br><br>
                Our pricing is customized based on your specific needs and project scope. We offer:<br><br>
                ‚Ä¢ Free initial consultation<br>
                ‚Ä¢ Transparent pricing with no hidden fees<br>
                ‚Ä¢ Flexible engagement models<br><br>
                Would you like to speak with someone about pricing for your specific needs?`
        },
        about: {
            keywords: ['about', 'who', 'company', 'history', 'story', 'founded', 'experience'],
            response: `üè¢ <strong>About X-Tech Enterprises:</strong><br><br>
                We've been transforming businesses since 1997! Led by seasoned executives, we specialize in bridging strategy and execution across dozens of industries.<br><br>
                Our mission: Partner with SMBs to transform legacy operations into competitive advantages through custom-tailored digital transformation.<br><br>
                Learn more on our <a href="story.html">Story page</a>!`
        },
        careers: {
            keywords: ['career', 'job', 'hiring', 'work', 'employment', 'position', 'join'],
            response: `üíº <strong>Careers at X-Tech:</strong><br><br>
                We're always looking for talented individuals who are passionate about business transformation!<br><br>
                Check out our <a href="careers.html">Careers page</a> to see current opportunities and learn about working with us.`
        },
        google: {
            keywords: ['google workspace', 'gmail', 'google', 'workspace', 'g suite', 'google drive'],
            response: `‚òÅÔ∏è <strong>Google Workspace Services:</strong><br><br>
                We're experts in Google Workspace! We provide:<br><br>
                ‚Ä¢ Migration & Setup<br>
                ‚Ä¢ Administration & Management<br>
                ‚Ä¢ Training & Support<br>
                ‚Ä¢ Custom integrations<br><br>
                We can help you get the most out of Google Workspace!`
        },
        location: {
            keywords: ['oklahoma', 'okc', 'local', 'nearby', 'remote'],
            response: `üìç <strong>Location & Service Area:</strong><br><br>
                We're based in Oklahoma City, Oklahoma, but we serve clients nationwide!<br><br>
                We offer both on-site and remote services depending on your needs.`
        }
    };

    // ============================================
    // Initialize Chat
    // ============================================
    function initializeChat() {
        addBotMessage(`Hi there! üëã<br><br>I'm the X-Tech AI Assistant. I can help you with information about our services, contact details, and more.<br><br>How can I help you today?`);

        // Show badge after delay
        setTimeout(() => {
            chatBadge.style.display = 'flex';
        }, 3000);
    }

    // ============================================
    // Message Management
    // ============================================
    function addMessage(text, isBot = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isBot ? 'bot-message' : 'user-message'}`;

        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

        messageDiv.innerHTML = `
            <div class="message-content">${text}</div>
            <span class="message-time">${timeString}</span>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Store in conversation history
        conversationHistory.push({
            sender: isBot ? 'bot' : 'user',
            message: text.replace(/<[^>]*>/g, ''), // Strip HTML for history
            timestamp: now.toISOString()
        });
    }

    function addBotMessage(text, delay = 0) {
        if (delay > 0) {
            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                addMessage(text, true);
            }, delay);
        } else {
            addMessage(text, true);
        }
    }

    function showTypingIndicator() {
        typingIndicator.style.display = 'flex';
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
    }

    // ============================================
    // Intelligent Response System
    // ============================================
    function getIntelligentResponse(userMessage) {
        const lowerMessage = userMessage.toLowerCase();

        // Check each knowledge base entry
        for (const [key, data] of Object.entries(knowledgeBase)) {
            for (const keyword of data.keywords) {
                if (lowerMessage.includes(keyword)) {
                    return data.response;
                }
            }
        }

        // If asking for human help
        if (lowerMessage.includes('human') || lowerMessage.includes('person') ||
            lowerMessage.includes('representative') || lowerMessage.includes('agent') ||
            lowerMessage.includes('talk to someone')) {
            return 'human_escalation';
        }

        // Default response if no match
        return `I'd be happy to help! I can provide information about:<br><br>
            ‚Ä¢ Our services and pricing<br>
            ‚Ä¢ Contact information and business hours<br>
            ‚Ä¢ Our company and team<br>
            ‚Ä¢ Career opportunities<br><br>
            Or, I can connect you with a team member. What would you like to know?`;
    }

    // ============================================
    // UI Event Handlers
    // ============================================
    chatButton.addEventListener('click', function() {
        chatOpen = !chatOpen;
        chatWindow.classList.toggle('open');
        chatButton.classList.toggle('open');
        chatBadge.style.display = 'none';

        if (chatOpen && chatMessages.children.length === 0) {
            initializeChat();
        }

        if (chatOpen) {
            chatInput.focus();
        }
    });

    minimizeChat.addEventListener('click', function() {
        chatWindow.classList.remove('open');
        chatButton.classList.remove('open');
        chatOpen = false;
    });

    // Quick action buttons
    document.querySelectorAll('.quick-action-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const action = this.getAttribute('data-action');

            if (action === 'human') {
                showContactForm();
            } else if (knowledgeBase[action]) {
                addMessage(this.textContent, false);
                addBotMessage(knowledgeBase[action].response, 800);
            }
        });
    });

    // Send message
    function sendMessage() {
        const message = chatInput.value.trim();

        if (message) {
            addMessage(message, false);
            chatInput.value = '';
            chatInput.style.height = 'auto';

            // Get intelligent response
            const response = getIntelligentResponse(message);

            if (response === 'human_escalation') {
                addBotMessage(`I'll connect you with our team right away! Please fill out this quick form and we'll get back to you shortly.`, 800);
                setTimeout(() => {
                    showContactForm();
                }, 1600);
            } else {
                addBotMessage(response, 1000);
            }
        }
    }

    sendButton.addEventListener('click', sendMessage);

    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Auto-resize textarea
    chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    // ============================================
    // Contact Form Management
    // ============================================
    function showContactForm() {
        chatInputContainer.style.display = 'none';
        quickActions.style.display = 'none';
        contactFormContainer.style.display = 'block';
        document.getElementById('contact-name').focus();
    }

    function hideContactForm() {
        contactFormContainer.style.display = 'none';
        chatInputContainer.style.display = 'flex';
        quickActions.style.display = 'grid';
        chatInput.focus();
    }

    cancelFormBtn.addEventListener('click', hideContactForm);

    // ============================================
    // Form Submission with Google Sheets Integration
    // ============================================
    contactForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const name = document.getElementById('contact-name').value.trim();
        const email = document.getElementById('contact-email').value.trim();
        const phone = document.getElementById('contact-phone').value.trim();
        const message = document.getElementById('contact-message').value.trim();

        // Disable form while submitting
        const submitBtn = contactForm.querySelector('.submit-btn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Sending...';
        submitBtn.disabled = true;

        try {
            // Check if Google Script URL is configured
            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                throw new Error('Google Apps Script URL not configured. Please see setup instructions.');
            }

            // Send to Google Apps Script
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Required for Google Apps Script
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    email: email,
                    phone: phone,
                    message: message,
                    conversationHistory: conversationHistory,
                    timestamp: new Date().toISOString(),
                    source: 'Website Chat Widget',
                    pageUrl: window.location.href
                })
            });

            // Success! (no-cors mode doesn't allow reading response, but we assume success)
            hideContactForm();
            addBotMessage(`‚úÖ Thank you, ${name}! Your message has been received.<br><br>We'll get back to you at ${email} within 24 hours.<br><br>For urgent matters, call us at (405) 247-0083.`, 500);

            // Reset form
            contactForm.reset();

        } catch (error) {
            console.error('Submission error:', error);
            addBotMessage(`‚ùå <strong>Submission Error</strong><br><br>${error.message}<br><br>Please try emailing us directly at sales@x-tech.tv or call (405) 247-0083.`, 500);
            hideContactForm();
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    });
});
</script>
